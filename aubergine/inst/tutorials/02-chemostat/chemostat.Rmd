---
title: "Modelling in R: A Chemostat"
author: "Thomas Petzoldt"
description: "The example shows a chemostat model by example of an autotrophic organisms, where growth is limited by a single nutrient (e.g. phosphorus) via a Monod equation."
date: "July-2021"
bibliography: chemostat.bib
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(learnr)
```

## Introduction

The example shows a chemostat model [cf. @Novick1950;@Herbert1956] by example of heterotrophic or autotrophic organisms (bacteria, algae, $X$), where growth is limited by a single nutrient (e.g. phosphorus, $P$) via a Monod equation.

## Implementation

The system is solved numerically with solvers from package **deSolve** [@Soetaert2010a], while equilibria at infinite time are estimated with package **rootSolve** [@Soetaert2009]. The implementation follows the standard formulation of these packages, see package documentation of **deSolve** and **rootSolve**, and @Soetaert2010a or @Soetaert2010c for details. 
The code is written in the **R** programming language for statistical computing [@RCore2018].

```{r, chemostat}
library("deSolve")
library("rootSolve")

chemostat <- function(time, init, parms) {
  with(as.list(c(init, parms)), {
    r       <- r_max * P/(kp + P)  # Monod equation
    dX_dt   <- r * X - D * X
    dP_dt   <- D * (P0 - P) - 1/Y * r * X
    list(c(dX_dt, dP_dt), r = r)
   })
}
parms <- c(
  r_max = 0.5,    # 1/d
  kp    = 0.5,    # half saturation constant, P (mol/m3)
  Y     = 106,    # yield coefficient (stoichiometric C:P ratio)
  D     = 0.1,    # 1/d
  P0    = 5       # P in inflow (mol/m3)
)
times <- seq(0, 40, 0.1)        # (d)
init  <- c(X = 10, P = 5)    # Phytoplankton C and Phosphorus P (mol/m3)
```

## Dynamic simulation

A dynamic simulation can then be performed by function `ode`, using the default algorithm `lsoda` with automatic integration step size. The result (`out`) is then a matrix-like object of class `deSolve` that is supported by a generic (i.e. object oriented) plot function.

```{r, single, , fig.height=3, fig.width=8}
out <- ode(init, times, chemostat, parms)
plot(out, mfrow=c(1, 3))
```

The plot function allows also to show several scenarios simultanaeously:

```{r, multiple, fig.height=3}
init  <- c(X=10, P=5)
p1 <- p2 <- p3 <- parms
p1["D"] <- 0; p2["D"] <- 0.3; p3["D"] <- 0.5
out <- ode(init, times, chemostat, parms)
out1 <- ode(init, times, chemostat, p1)
out2 <- ode(init, times, chemostat, p2)
out3 <- ode(init, times, chemostat, p3)

plot(out, out1, out2, out3, which=c("X", "P"))
```

## Steady State

The equilibrium can be aproximated numerically with package **rootSolve**. 
We use a loop here for simplicity, even if list-based approaches (e.g. `lapply`) 
may appear as more elegant for the intermediate and advanced **R** user.


```{r, steadystate, fig.height=3, fig.width=8}
state <- data.frame(
  D   = seq(0.01, 0.6, length.out = 100),
  X = 0,
  P   = 0
)

init  <- c(X=0.01, P=0.05) 

for (i in 1:nrow(state)) {
  parms["D"] <- state$D[i]
  times <- c(0, Inf)
  out <- runsteady(init, times, chemostat, parms)
  state[i, 2:3] <- out$y
}

par(mfrow = c(1, 3))
plot(P     ~ D, data = state, type = "l")
plot(X     ~ D, data = state, type = "l")
plot(P * X ~ D, data = state, type = "l")
```

## Analytical Solution

The same equilibrium can be reproduced by the analytical solution of chemostat equations.

```{r analytical, fig.height=3, fig.width=8}
D <- seq(0, 0.6, length.out = 100)
r_max = 0.5;  kp = 0.5; Y = 106; P0 = 5

P <- D * kp / (r_max - D)
P <- ifelse(D > (r_max * P0)/(kp + P0), P0, P)

X <- Y * (P0 - P)

par(mfrow=c(1, 3))
plot(D, P,        type="l")
plot(D, X,      type="l")
plot(D, X * P, type="l")
```



## Exercise: a chemostat with NPZ (work in progress)

* To do: make notation consistent to NPZD model

The chemostat equations can serve as a starting point for further extensions, e.g. the production of specific substances in bioreactors, or additional trophical levels. The equations are the fundamental for the description of other technical or non-technical flow-through systems, up to waste water treatment plants, or lakes. Here we want to go a small step in this direction and implement zooplankton as a third state variable and then test its behaviour.


## The model


```{r chemostat-npz}
chemostat <- function(time, init, parms) {
  with(as.list(c(init, parms)), {
    r       <- r_max * P / (kp + P)
    r_z     <- r_max_z * X / (k_X + X)

    dZ_dt   <- r_z * Z - D * Z
    dX_dt <- r * X - D * X - r_z * Z * 1/Y_z
    dP_dt   <- D * (P0 - P) - r * X * 1/Y
    list(c(dZ_dt, dX_dt, dP_dt))
   })
}
parms <- c(
  r_max = 0.5,    # 1/d
  kp    = 0.5,    # half saturation constant, P (mol/m3)
  Y     = 106,    # yield coefficient (stoichiometric C:P ratio)
  r_max_z = 0.2,  # max growth rate of zooplankton
  k_X   = 100,    # half sat zoopl. - algae
  Y_z   = 0.1,    # yield zooplankton
  D     = 0.1,    # 1/d
  P0    = 5       # P in inflow (mol/m3)
)

times <- seq(0, 200, 0.1)        # (d)

# Zoo and Phyto as C and Phosphorus P (mol/m3)
init  <- c(Z=10, X = 10, P = 5)
```

## Scenarios


* scenario 0: equilibrium, algae extinct
* scenario 1: Lotka-Volterra cycle
* scenario 2: equilibrium, zooplankton extinct
* scenario 3: equilibrium, coexistence
* scenario 4: equilibrium, both extinct
* scneario 5: damped oscillation


```{r chemostat-npz-scenarios, fig.height=3, fig.width=8}
parms["D"] <- 0.0
out0 <- ode(init, times, chemostat, parms)

parms["D"] <- 0.1
out1 <- ode(init, times, chemostat, parms)

parms["D"] <- 0.2
out2 <- ode(init, times, chemostat, parms)

parms["D"] <- 0.5
out4 <- ode(init, times, chemostat, parms)

plot(out0, out1, out2, out4, mfrow=c(1, 3))
```

```{r chemostat-npz-coexistence, fig.height=3, fig.width=8}
times <- seq(0, 2000, 0.1)        # (d)
parms["D"] <- 0.16
out3 <- ode(init, times, chemostat, parms)
plot(out4, mfrow=c(1, 3))
```

```{r chemostat-npz-damped, fig.height=3, fig.width=8}
# scenario X: damped Lotka-Volterra cycle
times <- seq(0, 2000, 0.1)        # (d)
parms["D"] <- 0.12
out5 <- ode(init, times, chemostat, parms)
plot(out5, mfrow=c(1, 3))
```

## References

<div id="refs"></div>

----
