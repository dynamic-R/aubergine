---
title: "Modelling in R: Bacterial Kinetics"
author: "Karline Soetaert and Thomas Petzoldt"
description: "This tutorial describes bacterial kinetics in a well-stirred closed system."
date: "July-2021"
output: 
  learnr::tutorial:
    progressive: true
    allow_skip: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(learnr)
```


## Bacterial dynamics: 

The scheme below describes bacterial kinetics in a well-stirred closed system, and describes bacterial biomass (B) and dissolved organic carbon (DOC), in units of mol C $m^{-3}$. 

![Bacterial-DOC dynamics](images/BactDOC.png)

Here the Bacteria and DOC are state variables whose dynamics we want to describe.

To make a mechanistic model, we start by creating the *mass balance equations*, which are defined as sources - sinks. From the conceptual scheme, we just record the arrows pointing towards (=sources) and arrows pointing away (=sinks) from the state variables.

Based on the above scheme we write:
$$
\frac{dB}{dt}= DOC\_uptake - Growth\_respiration - Mortality - Basal\_respiration\\
\frac{dDOC}{dt}= -DOC\_uptake + Mortality\\
$$
Next we define rate expressions for each of these rates:
$$
    DOC\_Uptake   = g \times \frac{DOC}{DOC+k_s} \times B\\
    Bact\_Death   = m \times B^2\\
    Basal\_Resp   = r \times B\\
    Growth\_Resp = (1-\gamma) \times DOC\_Uptake\\
$$
the parameter values are:

\tiny
parameter   |  value      | description                 | unit                        |
------------|-------------|---------------------------- | --------------------------- |
$g$         | 0.2         | uptake rate constant        |$hr^{-1}$                    |
$k_s$       | 10          | half-saturation constant    |$mol C~m^{-3}$               |
$\gamma$    | 0.5         | bacterial growth efficiency | -                           |
$r$         | 0.01        | basal respiration parameter |$hr^{-1}$                    |
$m$         | 0.0005      | mortality parameter         |$(mol C~m^{-3})^{-1} hr^{-1}$| 
\normalsize
and the initial conditions:
$$ B_0 = 0.1; \qquad DOC_0=100 \quad mol~m^{-3}$$

### Implementation in R

```{r model, message=FALSE}
require(deSolve)

#         [/hr], [mol/m3],  [-]   , [/hr] , [/(molC/m3)/hr]
parms <- c(g=0.2, ks=10, gamma=0.5, r=0.01, m=0.0005)  # parameters
y.ini <- c(B=0.1, DOC=100)           # [molC/m3] initial conditions

Bactmod <- function(t, y, p){        # derivative function
  with (as.list(c(y,p)),{

  # rates  
    DOC_Uptake  = g * DOC/(DOC+ks) * B
    Bact_Growth = gamma * DOC_Uptake
    Bact_Death  = m * B^2
    Basal_Resp  = r * B
    Growth_Resp = (1-gamma)*DOC_Uptake
  
  # mass balance
    dB.dt   <-  DOC_Uptake - Growth_Resp - Basal_Resp - Bact_Death
    dDOC.dt <- -DOC_Uptake + Bact_Death
  
  # return derivative vector and output variable  
    list(c(dB.dt, dDOC.dt), 
         TotalC=B+DOC)
  })
}

times <- seq(from=0, to=100, by=1)
out <- ode(y=y.ini, times=times, func=Bactmod, parms=parms)
plot(out)
```

TASK

You get as input the previous model. Your task is to add dissolved *in*organic carbon, DIC. (this is produced by the bacterial respiration). The initial concentration of DIC = 0.

```{r model3eq, exercise=TRUE}
require(deSolve)

#         [/hr], [mol/m3],  [-]   , [/hr] , [/(molC/m3)/hr]
parms <- c(g=0.2, ks=10, gamma=0.5, r=0.01, m=0.0005)  #          parameters
y.ini <- c(B=0.1, DOC=100)                          #[molC/m3] initial conditions

Bactmod <- function(t, y, p){        # derivative function
  with (as.list(c(y,p)),{

  # rates  
    DOC_Uptake  = g * DOC/(DOC+ks) * B
    Bact_Growth = gamma * DOC_Uptake
    Bact_Death  = m * B^2
    Basal_Resp  = r * B
    Growth_Resp = (1-gamma)*DOC_Uptake
  
  # mass balance
    dB.dt   <-  DOC_Uptake - Growth_Resp - Basal_Resp - Bact_Death
    dDOC.dt <- -DOC_Uptake + Bact_Death
  
  # return derivative vector and output variable  
    list(c(dB.dt, dDOC.dt), 
         TotalC=B+DOC)
  })
}

times <- seq(from=0, to=100, by=1)
out <- ode(y=y.ini, times=times, func=Bactmod, parms=parms)
plot(out)
```


```{r model3eq-solution}
require(deSolve)
parms <- c(g=0.2, ks=10, gamma=0.5, r=0.01, m=0.0005)  #          parameters
y.ini <- c(B=0.1, DOC=100, DIC=0)                      #[molC/m3] initial conditions

Bactmod <- function(t, y, p){        # derivative function
  with (as.list(c(y,p)),{

  # rates  
    DOC_Uptake  = g * DOC/(DOC+ks) * B
    Bact_Growth = gamma * DOC_Uptake
    Bact_Death  = m * B^2
    Basal_Resp  = r * B
    Growth_Resp = (1-gamma)*DOC_Uptake
  
  # mass balance
    dB.dt   <-  DOC_Uptake - Growth_Resp - Basal_Resp - Bact_Death
    dDOC.dt <- -DOC_Uptake + Bact_Death
    dDIC.dt <- Growth_Resp + Basal_Resp
  
    list(c(dB.dt, dDOC.dt, dDIC.dt), 
         TotalC=B+DOC+DIC)
  })
}

times <- seq(from=0, to=100, by=1)
out <- ode(y=y.ini, times=times, func=Bactmod, parms=parms)
plot(out)
```

<div id="model3eq-hint">
**Hint:** you will need to add a new state variable called DIC in y.ini; in the derivative function you must (1) specify the mass balance of DIC (call this dDIC.dt), and (2) return this in the derivative vector.
</div>

<div id="model3eq-hint">
**Hint:** you also need to include DIC in the total Carbon concentration, that should remain constant during the simulation.
</div>

## Finally

```{r feedback, echo = FALSE}
question("give your feedback ", type = "learnr_text", answer(" ", correct=TRUE), correct="thank you", incorrect = "thank you")
```

